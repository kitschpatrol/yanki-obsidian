name: Create Obsidian Plugin GitHub Release

on:
  push:
    tags:
      - '[0-9]*'

jobs:
  build:
    name: Create Release
    runs-on: ubuntu-latest
    env:
      ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
      IS_VALID_COMMIT: false
      TAG_NAME: ''
      ZIP_NAME: 'archive.zip'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log Token Type
        run: |
          if [ ${{ env.ACCESS_TOKEN }} == ${{ secrets.GITHUB_TOKEN }} ]; then
            echo "ðŸ—ï¸ Authenticated with GitHub Token"
          else
            echo "ðŸ”‘ Authenticated with Personal Access token"
          fi

      - name: Validate Tag and Branch
        id: validation
        run: |
          TAG=$(git tag --contains HEAD | grep '^[0-9]' | head -n 1)
          echo "ðŸ·ï¸ Tag for commit is: $TAG"
          BRANCH=$(git branch -r --contains tags/${GITHUB_REF_NAME} | grep 'origin/main' | xargs)
          if [[ -z "$BRANCH" ]]; then
            echo "ðŸš¨ Tag is not on main branch"
          else
            echo "ðŸ•Šï¸ Current branch is: $BRANCH"
          fi
          if [[ -z "$TAG" || -z "$BRANCH" ]]; then
            echo "IS_VALID_COMMIT=false" >> $GITHUB_ENV
            echo "TAG_NAME=''" >> $GITHUB_ENV
          else
            echo "IS_VALID_COMMIT=true" >> $GITHUB_ENV
            echo "TAG_NAME=$TAG" >> $GITHUB_ENV
          fi

      - name: Setup Pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - run: pnpm install

      - name: Build Plugin
        run: pnpm run build

      - name: Zip Artifacts
        run: |
          mkdir -p ./zip
          zip -r "./zip/${GITHUB_REPOSITORY##*/}-${TAG_NAME}.zip" dist/

      - name: Release Notes
        if: env.IS_VALID_COMMIT == 'true'
        id: release-notes
        uses: kitschpatrol/github-action-release-changelog@v2

      - name: Release
        if: env.IS_VALID_COMMIT == 'true'
        id: release
        uses: kitschpatrol/github-action-release@v2
        with:
          token: ${{ env.ACCESS_TOKEN }}
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
          name: ${{ env.TAG_NAME }}
          tag_name: ${{ env.TAG_NAME }}
          body: |
            ${{ steps.release-notes.outputs.changelog }}
          files: |
            dist/*
            zip/*

      - name: Log Release Details
        if: env.IS_VALID_COMMIT == 'true'
        run: |
          echo "ðŸ“¦ Successfully released: ${{ env.TAG_NAME }}"
          echo "ðŸ”— Release URL: ${{ steps.release.outputs.url }}"
          echo "ðŸªª Release ID: ${{ steps.release.outputs.id }}"
